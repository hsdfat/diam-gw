name: Update Performance Badge

on:
  workflow_run:
    workflows: ["Gateway CI/CD with Performance Testing"]
    types:
      - completed
    branches: [main]

jobs:
  update-badge:
    name: Update Performance Badge
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Download performance report
      uses: actions/github-script@v6
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: ${{ github.event.workflow_run.id }}
          });

          const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "performance-report"
          })[0];

          if (!matchArtifact) {
            core.setFailed('Performance report artifact not found');
            return;
          }

          const download = await github.rest.actions.downloadArtifact({
            owner: context.repo.owner,
            repo: context.repo.repo,
            artifact_id: matchArtifact.id,
            archive_format: 'zip',
          });

          const fs = require('fs');
          fs.writeFileSync('artifact.zip', Buffer.from(download.data));

    - name: Extract artifact
      run: |
        unzip artifact.zip
        cat performance-report.md

    - name: Parse performance metrics
      id: parse
      run: |
        # Extract metrics from markdown report
        ACTUAL_RATE=$(grep "| \*\*Actual Rate\*\*" performance-report.md | grep -oE '[0-9]+' | head -1 || echo "0")
        SUCCESS_PCT=$(grep "| \*\*Success Rate\*\*" performance-report.md | grep -oE '[0-9]+' | head -1 || echo "0")
        GRADE=$(grep "Performance Grade:" performance-report.md | grep -oE '\*\*[A-F]\*\*' | sed 's/\*//g' || echo "N/A")

        echo "Found metrics: rate=$ACTUAL_RATE, success=$SUCCESS_PCT%, grade=$GRADE"

        # Determine badge color based on grade
        case "$GRADE" in
          A)
            COLOR="brightgreen"
            MESSAGE="${ACTUAL_RATE} req/s (${SUCCESS_PCT}%)"
            ;;
          B)
            COLOR="green"
            MESSAGE="${ACTUAL_RATE} req/s (${SUCCESS_PCT}%)"
            ;;
          C)
            COLOR="yellow"
            MESSAGE="${ACTUAL_RATE} req/s (${SUCCESS_PCT}%)"
            ;;
          *)
            COLOR="red"
            MESSAGE="${ACTUAL_RATE} req/s"
            ;;
        esac

        echo "rate=$ACTUAL_RATE" >> $GITHUB_OUTPUT
        echo "success_pct=$SUCCESS_PCT" >> $GITHUB_OUTPUT
        echo "grade=$GRADE" >> $GITHUB_OUTPUT
        echo "color=$COLOR" >> $GITHUB_OUTPUT
        echo "message=$MESSAGE" >> $GITHUB_OUTPUT

    - name: Create performance badge
      run: |
        mkdir -p .github/badges

        # Create badge JSON for shields.io endpoint
        cat > .github/badges/performance.json << EOF
        {
          "schemaVersion": 1,
          "label": "performance",
          "message": "${{ steps.parse.outputs.message }}",
          "color": "${{ steps.parse.outputs.color }}"
        }
        EOF

        cat > .github/badges/grade.json << EOF
        {
          "schemaVersion": 1,
          "label": "grade",
          "message": "Grade ${{ steps.parse.outputs.grade }}",
          "color": "${{ steps.parse.outputs.color }}"
        }
        EOF

        # Save performance history
        mkdir -p .github/performance-history
        TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S')
        COMMIT="${{ github.event.workflow_run.head_sha }}"
        COMMIT_SHORT=$(echo $COMMIT | cut -c1-7)

        # Create/append to history CSV
        if [ ! -f .github/performance-history/history.csv ]; then
          echo "timestamp,commit,rate,success_pct,grade" > .github/performance-history/history.csv
        fi

        echo "${TIMESTAMP},${COMMIT_SHORT},${{ steps.parse.outputs.rate }},${{ steps.parse.outputs.success_pct }},${{ steps.parse.outputs.grade }}" >> .github/performance-history/history.csv

        # Keep only last 100 entries
        tail -100 .github/performance-history/history.csv > .github/performance-history/history.tmp
        mv .github/performance-history/history.tmp .github/performance-history/history.csv

    - name: Commit badges and history
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .github/badges/ .github/performance-history/
        git diff --staged --quiet || git commit -m "Update performance badges and history [skip ci]

        Performance: ${{ steps.parse.outputs.rate }} req/s (${{ steps.parse.outputs.success_pct }}%)
        Grade: ${{ steps.parse.outputs.grade }}"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
