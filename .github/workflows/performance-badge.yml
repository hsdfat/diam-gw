name: Update Performance Badge

on:
  workflow_run:
    workflows: ["Gateway CI/CD with Performance Testing"]
    types:
      - completed
    branches: [main]

jobs:
  update-badge:
    name: Update Performance Badge
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Download performance report
      uses: actions/github-script@v6
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: ${{ github.event.workflow_run.id }}
          });

          const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "performance-report"
          })[0];

          if (!matchArtifact) {
            core.setFailed('Performance report artifact not found');
            return;
          }

          const download = await github.rest.actions.downloadArtifact({
            owner: context.repo.owner,
            repo: context.repo.repo,
            artifact_id: matchArtifact.id,
            archive_format: 'zip',
          });

          const fs = require('fs');
          fs.writeFileSync('artifact.zip', Buffer.from(download.data));

    - name: Extract artifact
      run: |
        unzip artifact.zip
        cat performance-report.md

    - name: Parse performance metrics
      id: parse
      run: |
        # Extract metrics from markdown report
        ACTUAL_RATE=$(grep "Actual Rate:" performance-report.md | grep -oE '[0-9]+' | head -1 || echo "0")
        GRADE=$(grep "Overall Grade" -A 1 performance-report.md | tail -1 | sed 's/\*\*//g' || echo "Unknown")

        # Determine badge color based on grade
        case "$GRADE" in
          *A*)
            COLOR="brightgreen"
            ;;
          *B*)
            COLOR="green"
            ;;
          *C*)
            COLOR="yellow"
            ;;
          *)
            COLOR="red"
            ;;
        esac

        echo "rate=$ACTUAL_RATE" >> $GITHUB_OUTPUT
        echo "grade=$GRADE" >> $GITHUB_OUTPUT
        echo "color=$COLOR" >> $GITHUB_OUTPUT

    - name: Create performance badge
      run: |
        mkdir -p .github/badges

        # Create badge JSON for shields.io
        cat > .github/badges/performance.json << EOF
        {
          "schemaVersion": 1,
          "label": "performance",
          "message": "${{ steps.parse.outputs.rate }} req/s",
          "color": "${{ steps.parse.outputs.color }}"
        }
        EOF

        cat > .github/badges/grade.json << EOF
        {
          "schemaVersion": 1,
          "label": "grade",
          "message": "${{ steps.parse.outputs.grade }}",
          "color": "${{ steps.parse.outputs.color }}"
        }
        EOF

    - name: Commit badges
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .github/badges/
        git diff --staged --quiet || git commit -m "Update performance badges [skip ci]"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
